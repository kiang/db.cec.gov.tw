<?php
/*
 *
  [OBJECTID_1] => 1
  [VILLAGE] => 中山里
  [TOWN] => 東區
  [COUNTY] => 嘉義市
  [VILLAGE_ID] => 061
  [TOWN_ID] => 10020010
  [COUNTY_ID] => 10020
  [TV_ALL] => 東區中山里
  [VILLCODE] => A2001-061-00
  [ORI_VILLAG] =>
  [AREA] => 230686.768164
  [MAX_X] => 195185.2188
  [MAX_Y] => 2598108.1036
  [MIN_X] => 194071.1719
  [MIN_Y] => 2597691.75
  [X] => 194698.790489
  [Y] => 2597889.20695
  [V_ID] => 10020010-061
 */

$basePath = dirname(__DIR__);
$codes = array();
$json = json_decode(file_get_contents('/home/kiang/public_html/taiwan_basecode/cunli/topo/20150401.json'), true);
foreach ($json['objects']['20150401']['geometries'] AS $obj) {
    if ($obj['properties']['C_Name'] === '桃園縣') {
        $obj['properties']['C_Name'] = '桃園市';
        $obj['properties']['T_Name'] = mb_substr($obj['properties']['T_Name'], 0, -1, 'utf-8') . '區';
        $obj['properties']['V_Name'] = mb_substr($obj['properties']['V_Name'], 0, -1, 'utf-8') . '里';
    }
    $codes["{$obj['properties']['C_Name']}{$obj['properties']['T_Name']}{$obj['properties']['V_Name']}"] = $obj['properties']['VILLAGE_ID'];
}

$header = array('省市', '縣市', '選區', '鄉鎮市區', '村里', '名稱');
$fh = fopen($basePath . '/voteData/2014-103年地方公職人員選舉/直轄市區域議員/elbase.csv', 'r');

$stack = array(
    630000200019 => '6300200-019',
    630000700015 => '6300700-015',
    650000100021 => '6500100-021',
    650000300017 => '6500300-017',
    650000300054 => '6500300-054',
    650000400045 => '6500400-045',
    650000700007 => '6500700-007',
    650001300017 => '6501300-017',
    650000900006 => '6500900-006',
    650000600041 => '6500600-041',
    650002000004 => '6502000-004',
    650001200007 => '6501200-007',
    650001200028 => '6501200-028',
    650001200027 => '6501200-027',
    650002800008 => '6502800-008',
    680000600011 => '6800600-011',
    680001100020 => '6801100-020',
    660002200004 => '6602200-004',
    660002100011 => '6602100-011',
    660001200016 => '6601200-016',
    660002400016 => '6602400-016',
    660000609999 => array('6600600-035', '6600600-020'),
    660000800013 => '6600800-013',
    660000400009 => '6600400-009',
    660000400024 => '6600400-024',
    670000500016 => '6700500-016',
    670000100022 => '6700100-022',
    670000700004 => '6700700-004',
    670000700015 => '6700700-015',
    670001000008 => '6701000-008',
    670001500007 => '6701500-007',
    670001500020 => '6701500-020',
    670001200014 => '6701200-014',
    670002200005 => '6702200-005',
    670001800016 => '6701800-016',
    670001800018 => '6701800-018',
    670003100010 => '6703100-010',
    670003100029 => '6703100-029',
    670003500003 => '6703500-003',
    670003500024 => '6703500-019',
    670003500019 => '6703500-024',
    670003000008 => '6703000-008',
    640002500004 => '6402500-004',
    640002300003 => '6402300-003',
    640000300027 => '6400300-027',
    640000300028 => '6400300-028',
    640001800004 => '6401800-004',
    100040200006 => '1000402-006',
    100040200012 => '1000402-012',
    100040900004 => '1000409-004',
    100051300002 => '1000513-002',
    100051300003 => '1000513-003',
    100050200014 => '1000502-014',
    100050200021 => '1000502-021',
    100050400018 => '1000504-018',
    100050709999 => array('1000507-005', '1000507-011'),
    100070100039 => '1000701-039',
    100070100030 => '1000701-030',
    100070100002 => '1000701-002',
    100070100059 => '1000701-059',
    100071000030 => '1000710-030',
    100071400003 => '1000714-003',
    100071400010 => '1000714-010',
    100071500012 => '1000715-012',
    100071500013 => '1000715-013',
    100071500014 => '1000715-014',
    100071500020 => '1000715-020',
    100072300013 => '1000723-013',
    100080600012 => '1000806-012',
    100080400005 => '1000804-005',
    100081300016 => '1000813-016',
    100090100018 => '1000901-018',
    100091700018 => '1000917-018',
    100090400027 => '1000904-027',
    100091300003 => '1000913-003',
    100091600001 => '1000916-001',
    100092000021 => '1000920-021',
    100090600011 => '1000906-011',
    100100500023 => '1001005-023',
    100101500010 => '1001015-010',
    100101500015 => '1001015-015',
    100100200012 => '1001002-012',
    100101300002 => '1001013-002',
    100101300014 => '1001013-014',
    100101400018 => '1001014-018',
    100130900012 => '1001309-012',
    100132800003 => '1001328-003',
    100130300017 => '1001303-017',
    100130500012 => '1001305-012',
    100130500013 => '1001305-013',
    100131700001 => '1001317-001',
    100131900007 => '1001319-007',
    100132400005 => '1001324-005',
    100140809999 => array('1001408-002', '1001408-001'),
    100140300005 => '1001403-005',
    100141500001 => '1001415-001',
    100141500002 => '1001415-002',
    100141100001 => '1001411-001',
    100160100031 => '1001601-031',
    100160200022 => '1001602-022',
    100200200018 => '1002002-018',
    '090200100003' => '0902001-003',
    '090200100002' => '0902001-002',
    '090200100004' => '0902001-004',
    '090070100002' => array('0900701-002', '0900701-003'),
    '090070100004' => array('0900701-004', '0900701-005', '0900701-006', '0900701-007', '0900701-008', '0900701-009'),
    '090070200001' => array('0900702-001', '0900702-002', '0900702-003'),
    '090070200004' => array('0900702-004', '0900702-005', '0900702-006'),
    '090070300001' => array('0900703-001', '0900703-002', '0900703-003'),
    '090070300005' => array('0900703-005', '0900703-004'),
    '090070400001' => array('0900704-001', '0900704-002'),
);
$result = $zone = array();
while ($line = fgetcsv($fh, 2048)) {
    foreach ($line AS $k => $v) {
        $line[$k] = trim($v, '\'');
    }
    $line = array_combine($header, $line);
    if ($line['省市'] === '00') {
        continue;
    }
    if ($line['鄉鎮市區'] === '000') {
        $city = $line['名稱'];
    } elseif ($line['村里'] === '0000') {
        $area = $line['名稱'];
    } else {
        $k = "{$city}{$area}{$line['名稱']}";
        $code = "{$line['省市']}{$line['縣市']}{$line['鄉鎮市區']}{$line['村里']}";
        $vcode = false;
        if (isset($codes[$k])) {
            $vcode = $codes[$k];
            unset($codes[$k]);
        } elseif (isset($stack[$code])) {
            $vcode = $stack[$code];
            if (!is_array($vcode)) {
                $k = array_search($vcode, $codes);
                if (false !== $k) {
                    unset($codes[$k]);
                }
            } else {
                foreach ($vcode AS $c) {
                    $k = array_search($c, $codes);
                    if (false !== $k) {
                        unset($codes[$k]);
                    }
                }
            }
        }
        if (false !== $vcode) {
            $result[$code] = $vcode;
            if (is_array($vcode)) {
                foreach ($vcode AS $v) {
                    $zone[$v] = $area;
                }
            } else {
                $zone[$vcode] = $area;
            }
        }
    }
}

$fh = fopen($basePath . '/voteData/2014-103年地方公職人員選舉/縣市區域議員/elbase.csv', 'r');

while ($line = fgetcsv($fh, 2048)) {
    foreach ($line AS $k => $v) {
        $line[$k] = trim($v, '\'');
    }
    $line = array_combine($header, $line);
    if ($line['省市'] === '00') {
        continue;
    }
    if ($line['鄉鎮市區'] === '000') {
        $city = $line['名稱'];
    } elseif ($line['村里'] === '0000') {
        $area = $line['名稱'];
    } else {
        $k = "{$city}{$area}{$line['名稱']}";
        $code = "{$line['省市']}{$line['縣市']}{$line['鄉鎮市區']}{$line['村里']}";
        $vcode = false;
        if (isset($codes[$k])) {
            $vcode = $codes[$k];
            unset($codes[$k]);
        } elseif (isset($stack[$code])) {
            $vcode = $stack[$code];
            if (!is_array($vcode)) {
                $k = array_search($vcode, $codes);
                if (false !== $k) {
                    unset($codes[$k]);
                }
            } else {
                foreach ($vcode AS $c) {
                    $k = array_search($c, $codes);
                    if (false !== $k) {
                        unset($codes[$k]);
                    }
                }
            }
        }
        if (false !== $vcode) {
            $result[$code] = $vcode;
            if (is_array($vcode)) {
                foreach ($vcode AS $v) {
                    $zone[$v] = $area;
                }
            } else {
                $zone[$vcode] = $area;
            }
        }
    }
}

$councilPath = $basePath . '/data/council/2014';
if(!file_exists($councilPath)) {
    mkdir($councilPath, 0777, true);
}

file_put_contents($councilPath . '/vcode.php', '<?php return ' . var_export($result, true) . ';');
file_put_contents($councilPath . '/zone.php', '<?php return ' . var_export($zone, true) . ';');