<?php
/*
 *
  [OBJECTID_1] => 1
  [VILLAGE] => 中山里
  [TOWN] => 東區
  [COUNTY] => 嘉義市
  [VILLAGE_ID] => 061
  [TOWN_ID] => 10020010
  [COUNTY_ID] => 10020
  [TV_ALL] => 東區中山里
  [VILLCODE] => A2001-061-00
  [ORI_VILLAG] =>
  [AREA] => 230686.768164
  [MAX_X] => 195185.2188
  [MAX_Y] => 2598108.1036
  [MIN_X] => 194071.1719
  [MIN_Y] => 2597691.75
  [X] => 194698.790489
  [Y] => 2597889.20695
  [V_ID] => 10020010-061
 */

$basePath = dirname(dirname(__DIR__));
$codes = array();
$json = json_decode(file_get_contents('/home/kiang/public_html/taiwan_basecode/cunli/topo/20180330.json'), true);
foreach ($json['objects']['20180330']['geometries'] as $obj) {
    $codes["{$obj['properties']['COUNTYNAME']}{$obj['properties']['TOWNNAME']}{$obj['properties']['VILLNAME']}"] = $obj['properties']['VILLCODE'];
}

$header = array('省市', '縣市', '選區', '鄉鎮市區', '村里', '名稱');
$fh = fopen($basePath . '/voteData/2018-107年地方公職人員選舉/直轄市區域議員/elbase.csv', 'r');

$stack = array(
    630000700015 => '63000070015',
    650000100021 => '65000010021',
    650000300017 => '65000030017',
    650000300054 => '65000030054',
    650000400045 => '65000040045',
    650000700007 => '65000070007',
    650000900006 => '65000090006',
    650001300017 => '65000130017',
    650000600041 => '65000060041',
    650002000004 => '65000200004',
    650001200007 => '65000120007',
    650001200027 => '65000120027',
    650001200028 => '65000120028',
    650002800008 => '65000280008',
    680000600011 => '68000060011',
    680001100020 => '68000110020',
    660002100011 => '66000210011',
    660002200004 => '66000220004',
    660001200016 => '66000120016',
    660002400016 => '66000240016',
    660000800013 => '66000080013',
    660000400009 => '66000040009',
    660000400024 => '66000040024',
    670000200033 => '67000020033',
    670001500007 => '67000150007',
    670000700004 => '67000070004',
    670000700015 => '67000070015',
    670001000008 => '67000100008',
    670001800016 => '67000180016',
    670001800018 => '67000180018',
    670002200005 => '67000220005',
    670003500003 => '67000350003',
    670003500024 => '67000350024',
    670003500019 => '67000350019',
    670003100010 => '67000310010',
    670003100029 => '67000310029',
    670003100043 => '67000310043',
    670003000008 => '67000300008',
    640002300003 => '64000230003',
    640002500004 => '64000250004',
    640000300027 => '64000030027',
    640000300028 => '64000030028',
    640001800004 => '64000180004',
    100040200006 => '10004020006',
    100040200012 => '10004020012',
    100040900004 => '10004090004',
    100051300002 => '10005130002',
    100051300003 => '10005130003',
    100050200014 => '10005020014',
    100050200021 => '10005020021',
    100050400018 => '10005040018',
    100070100002 => '10007010002',
    100070100030 => '10007010030',
    100070100039 => '10007010039',
    100070100059 => '10007010059',
    100071000030 => '10007100030',
    100071400003 => '10007140003',
    100071400010 => '10007140010',
    100071500012 => '10007150012',
    100071500013 => '10007150013',
    100071500014 => '10007150014',
    100071500020 => '10007150020',
    100072300013 => '10007230013',
    100080600012 => '10008060012',
    100080400005 => '10008040005',
    100090100018 => '10009010018',
    100090100039 => '10009010039',
    100090200023 => '10009020023',
    100090200024 => '10009020024',
    100091700018 => '10009170018',
    100090400027 => '10009040027',
    100091300003 => '10009130003',
    100091600001 => '10009160001',
    100091800016 => '10009180016',
    100091800021 => '10009180021',
    100090600011 => '10009060011',
    100092000021 => '10009200021',
    100100500023 => '10010050023',
    100101500010 => '10010150010',
    100101500015 => '10010150015',
    100100200012 => '10010020012',
    100101300002 => '10010130002',
    100101300014 => '10010130014',
    100101400018 => '10010140018',
    100130900012 => '10013090012',
    100132800003 => '10013280003',
    100130300017 => '10013030017',
    100130500012 => '10013050012',
    100130500013 => '10013050013',
    100131700001 => '10013170001',
    100131900007 => '10013190007',
    100132400005 => '10013240005',
    100140300005 => '10014030005',
    100141500001 => '10014150001',
    100141500002 => '10014150002',
    100141100001 => '10014110001',
    100160100031 => '10016010031',
    100160200022 => '10016020022',
    100200200018 => '10020020018',
    '090070100003' => ['09007010003', '09007010002'],
    '090070100004' => ['09007010004', '09007010008'],
    '090070100007' => ['09007010007', '09007010006', '09007010009', '09007010005'],
    '090070200002' => ['09007020002', '09007020003', '09007020001'],
    '090070200005' => ['09007020005', '09007020006', '09007020004'],
    '090070300002' => ['09007030002', '09007030003', '09007030001'],
    '090070300005' => ['09007030005', '09007030004'],
    '090070400002' => ['09007040002', '09007040001'],
);
$result = $zone = array();
while ($line = fgetcsv($fh, 2048)) {
    foreach ($line as $k => $v) {
        $line[$k] = trim($v, '\'');
    }
    $line = array_combine($header, $line);
    if ($line['省市'] === '00') {
        continue;
    }
    if ($line['鄉鎮市區'] === '000') {
        $city = $line['名稱'];
    } elseif ($line['村里'] === '0000') {
        $area = $line['名稱'];
    } else {
        $k = "{$city}{$area}{$line['名稱']}";
        $code = "{$line['省市']}{$line['縣市']}{$line['鄉鎮市區']}{$line['村里']}";
        $vcode = false;
        if (isset($codes[$k])) {
            $vcode = $codes[$k];
            unset($codes[$k]);
        } elseif (isset($stack[$code])) {
            $vcode = $stack[$code];
            if (!is_array($vcode)) {
                $k = array_search($vcode, $codes);
                if (false !== $k) {
                    unset($codes[$k]);
                }
            } else {
                foreach ($vcode as $c) {
                    $k = array_search($c, $codes);
                    if (false !== $k) {
                        unset($codes[$k]);
                    }
                }
            }
        } else {
            echo "{$code} => '{$k}',\n";
        }
        if (false !== $vcode) {
            $result[$code] = $vcode;
            if (is_array($vcode)) {
                foreach ($vcode as $v) {
                    $zone[$v] = $area;
                }
            } else {
                $zone[$vcode] = $area;
            }
        }
    }
}

$fh = fopen($basePath . '/voteData/2018-107年地方公職人員選舉/縣市區域議員/elbase.csv', 'r');

while ($line = fgetcsv($fh, 2048)) {
    foreach ($line as $k => $v) {
        $line[$k] = trim($v, '\'');
    }
    $line = array_combine($header, $line);
    if ($line['省市'] === '00') {
        continue;
    }
    if ($line['鄉鎮市區'] === '000') {
        $city = $line['名稱'];
    } elseif ($line['村里'] === '0000') {
        $area = $line['名稱'];
    } else {
        $k = "{$city}{$area}{$line['名稱']}";
        $code = "{$line['省市']}{$line['縣市']}{$line['鄉鎮市區']}{$line['村里']}";
        $vcode = false;
        if (isset($codes[$k])) {
            $vcode = $codes[$k];
            unset($codes[$k]);
        } elseif (isset($stack[$code])) {
            $vcode = $stack[$code];
            if (!is_array($vcode)) {
                $k = array_search($vcode, $codes);
                if (false !== $k) {
                    unset($codes[$k]);
                }
            } else {
                foreach ($vcode as $c) {
                    $k = array_search($c, $codes);
                    if (false !== $k) {
                        unset($codes[$k]);
                    }
                }
            }
        } else {
            echo "{$code} => '{$k}',\n";
        }
        if (false !== $vcode) {
            $result[$code] = $vcode;
            if (is_array($vcode)) {
                foreach ($vcode as $v) {
                    $zone[$v] = $area;
                }
            } else {
                $zone[$vcode] = $area;
            }
        }
    }
}

$councilPath = $basePath . '/data/council/2018';
if (!file_exists($councilPath)) {
    mkdir($councilPath, 0777, true);
}

file_put_contents($councilPath . '/vcode.php', '<?php return ' . var_export($result, true) . ';');
file_put_contents($councilPath . '/zone.php', '<?php return ' . var_export($zone, true) . ';');
