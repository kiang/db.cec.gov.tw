<?php
$dataPath = dirname(dirname(__DIR__)) . '/data';
$fh = fopen($dataPath . '/council/2022/cunli.csv', 'r');
fgetcsv($fh, 2048);
$zones = [
    '臺北市信義區富台里' => '63000-03',
    '臺北市萬華區糖廍里' => '63000-05',
    '新北市板橋區公舘里' => '65000-05',
    '新北市中和區瓦磘里' => '65000-06',
    '新北市中和區灰磘里' => '65000-06',
    '新北市永和區新廍里' => '65000-07',
    '新北市新店區五峯里' => '65000-09',
    '新北市樹林區獇寮里' => '65000-08',
    '新北市三峽區永舘里' => '65000-08',
    '新北市瑞芳區爪峯里' => '65000-10',
    '新北市瑞芳區濓新里' => '65000-10',
    '新北市瑞芳區濓洞里' => '65000-10',
    '新北市土城區峯廷里' => '65000-08',
    '新北市坪林區石𥕢里' => '65000-09',
    '新北市萬里區崁脚里' => '65000-11',
    '桃園市桃園區大樹里' => '68000-01',
    '桃園市桃園區大業里' => '68000-01',
    '桃園市桃園區福元里' => '68000-01',
    '桃園市大溪區仁美里' => '68000-06',
    '桃園市蘆竹區正興里' => '68000-04',
    '桃園市蘆竹區濱海里' => '68000-04',
    '桃園市大園區菓林里' => '68000-05',
    '桃園市龜山區文青里' => '68000-02',
    '桃園市龜山區楓福里' => '68000-02',
    '桃園市龍潭區祥和里' => '68000-10',
    '桃園市新屋區槺榔里' => '68000-11',
    '臺中市西區公舘里' => '66000-10',
    '臺中市西區双龍里' => '66000-10',
    '臺中市北屯區廍子里' => '66000-08',
    '臺中市清水區槺榔里' => '66000-02',
    '臺中市外埔區廍子里' => '66000-01',
    '臺中市大安區龜壳里' => '66000-01',
    '臺中市大肚區蔗廍里' => '66000-03',
    '臺南市新營區永平里' => '67000-01',
    '臺南市鹽水區津城里' => '67000-01',
    '臺南市鹽水區月港里' => '67000-01',
    '臺南市鹽水區三明里' => '67000-01',
    '臺南市鹽水區義中里' => '67000-01',
    '臺南市鹽水區文昌里' => '67000-01',
    '臺南市鹽水區竹林里' => '67000-01',
    '臺南市鹽水區三和里' => '67000-01',
    '臺南市鹽水區坔頭港里' => '67000-01',
    '臺南市白河區詔豐里' => '67000-01',
    '臺南市白河區廣蓮里' => '67000-01',
    '臺南市白河區馬稠後里' => '67000-01',
    '臺南市後壁區長短樹里' => '67000-01',
    '臺南市後壁區上茄苳里' => '67000-01',
    '臺南市後壁區菁豐里' => '67000-01',
    '臺南市麻豆區晋江里' => '67000-03',
    '臺南市麻豆區寮廍里' => '67000-03',
    '臺南市麻豆區新興里' => '67000-03',
    '臺南市麻豆區謝厝寮里' => '67000-03',
    '臺南市麻豆區井東里' => '67000-03',
    '臺南市麻豆區清水里' => '67000-03',
    '臺南市下營區茅營里' => '67000-03',
    '臺南市下營區大吉里' => '67000-03',
    '臺南市下營區紅甲里' => '67000-03',
    '臺南市官田區南廍里' => '67000-03',
    '臺南市官田區烏山頭里' => '67000-03',
    '臺南市官田區渡拔里' => '67000-03',
    '臺南市官田區東西庄里' => '67000-03',
    '臺南市佳里區營溪里' => '67000-02',
    '臺南市佳里區文新里' => '67000-02',
    '臺南市佳里區佳興里' => '67000-02',
    '臺南市佳里區下營里' => '67000-02',
    '臺南市佳里區塭內里' => '67000-02',
    '臺南市佳里區南勢里' => '67000-02',
    '臺南市七股區塩埕里' => '67000-02',
    '臺南市將軍區巷埔里' => '67000-02',
    '臺南市將軍區西甲里' => '67000-02',
    '臺南市將軍區忠嘉里' => '67000-02',
    '臺南市將軍區苓仔寮里' => '67000-02',
    '臺南市將軍區將軍里' => '67000-02',
    '臺南市北門區蚵寮里' => '67000-02',
    '臺南市北門區文山里' => '67000-02',
    '臺南市新化區山脚里' => '67000-05',
    '臺南市新化區𦰡拔里' => '67000-05',
    '臺南市善化區頂街里' => '67000-05',
    '臺南市善化區昌隆里' => '67000-05',
    '臺南市善化區蓮潭里' => '67000-05',
    '臺南市安定區文科里' => '67000-05',
    '臺南市安定區嘉同里' => '67000-05',
    '臺南市山上區玉峯里' => '67000-05',
    '臺南市仁德區文賢里' => '67000-11',
    '臺南市關廟區花園里' => '67000-11',
    '臺南市關廟區南雄里' => '67000-11',
    '臺南市龍崎區石𥕢里' => '67000-11',
    '臺南市永康區塩行里' => '67000-07',
    '臺南市永康區塩洲里' => '67000-07',
    '臺南市永康區北興里' => '67000-07',
    '臺南市永康區龍埔里' => '67000-07',
    '臺南市永康區永明里' => '67000-07',
    '臺南市永康區塩興里' => '67000-07',
    '臺南市南區鹽埕里' => '67000-09',
    '臺南市北區長勝里' => '67000-08',
    '臺南市北區合興里' => '67000-08',
    '臺南市北區北門里' => '67000-08',
    '臺南市北區小北里' => '67000-08',
    '臺南市北區大光里' => '67000-08',
    '臺南市北區大興里' => '67000-08',
    '臺南市北區長興里' => '67000-08',
    '臺南市北區北華里' => '67000-08',
    '臺南市北區華德里' => '67000-08',
    '臺南市北區福德里' => '67000-08',
    '臺南市北區立人里' => '67000-08',
    '臺南市北區雙安里' => '67000-08',
    '臺南市北區元美里' => '67000-08',
    '臺南市安南區塩田里' => '67000-06',
    '臺南市安平區天妃里' => '67000-09',
    '臺南市安平區王城里' => '67000-09',
    '臺南市中西區城隍里' => '67000-08',
    '臺南市中西區南美里' => '67000-08',
    '臺南市中西區南門里' => '67000-08',
    '臺南市中西區小西門里' => '67000-08',
    '臺南市中西區五條港里' => '67000-08',
    '臺南市中西區兌悅里' => '67000-08',
    '臺南市中西區淺草里' => '67000-08',
    '臺南市中西區府前里' => '67000-08',
    '臺南市中西區南廠里' => '67000-08',
    '臺南市中西區西和里' => '67000-08',
    '高雄市左營區廍北里' => '64000-04',
    '高雄市左營區廍南里' => '64000-04',
    '高雄市鳥松區坔埔里' => '64000-05',
    '高雄市阿蓮區峯山里' => '64000-02',
    '高雄市湖內區公舘里' => '64000-02',
    '新竹縣竹北市中崙里' => '10004-01',
    '新竹縣竹東鎮上舘里' => '10004-08',
    '新竹縣竹東鎮鷄林里' => '10004-08',
    '新竹縣北埔鄉水磜村' => '10004-10',
    '苗栗縣苑裡鎮山脚里' => '10005-03',
    '苗栗縣苑裡鎮上舘里' => '10005-03',
    '苗栗縣竹南鎮公舘里' => '10005-04',
    '苗栗縣頭份市流東里' => '10005-05',
    '苗栗縣頭份市珊湖里' => '10005-05',
    '苗栗縣頭份市斗煥里' => '10005-05',
    '苗栗縣頭份市新華里' => '10005-05',
    '苗栗縣頭份市興隆里' => '10005-05',
    '苗栗縣頭份市上埔里' => '10005-05',
    '苗栗縣頭份市土牛里' => '10005-05',
    '苗栗縣頭份市頭份里' => '10005-05',
    '苗栗縣頭份市忠孝里' => '10005-05',
    '苗栗縣頭份市仁愛里' => '10005-05',
    '苗栗縣頭份市信義里' => '10005-05',
    '苗栗縣頭份市和平里' => '10005-05',
    '苗栗縣頭份市民族里' => '10005-05',
    '苗栗縣頭份市東庄里' => '10005-05',
    '苗栗縣頭份市後庄里' => '10005-05',
    '苗栗縣頭份市山下里' => '10005-05',
    '苗栗縣頭份市蟠桃里' => '10005-05',
    '苗栗縣頭份市田寮里' => '10005-05',
    '苗栗縣頭份市蘆竹里' => '10005-05',
    '苗栗縣頭份市上興里' => '10005-05',
    '苗栗縣頭份市下興里' => '10005-05',
    '苗栗縣頭份市尖山里' => '10005-05',
    '苗栗縣頭份市尖下里' => '10005-05',
    '苗栗縣頭份市廣興里' => '10005-05',
    '苗栗縣頭份市濫坑里' => '10005-05',
    '苗栗縣頭份市民權里' => '10005-05',
    '苗栗縣頭份市民生里' => '10005-05',
    '苗栗縣頭份市建國里' => '10005-05',
    '苗栗縣頭份市成功里' => '10005-05',
    '苗栗縣頭份市自強里' => '10005-05',
    '苗栗縣頭份市合興里' => '10005-05',
    '苗栗縣頭份市文化里' => '10005-05',
    '苗栗縣頭份市中興里' => '10005-05',
    '苗栗縣三義鄉双湖村' => '10005-02',
    '苗栗縣三義鄉双潭村' => '10005-02',
    '彰化縣彰化市下廍里' => '10007-01',
    '彰化縣彰化市磚磘里' => '10007-01',
    '彰化縣彰化市南瑶里' => '10007-01',
    '彰化縣彰化市寶廍里' => '10007-01',
    '彰化縣員林市東和里' => '10007-04',
    '彰化縣員林市民生里' => '10007-04',
    '彰化縣員林市中正里' => '10007-04',
    '彰化縣員林市仁美里' => '10007-04',
    '彰化縣員林市新興里' => '10007-04',
    '彰化縣員林市和平里' => '10007-04',
    '彰化縣員林市光明里' => '10007-04',
    '彰化縣員林市中山里' => '10007-04',
    '彰化縣員林市黎明里' => '10007-04',
    '彰化縣員林市惠來里' => '10007-04',
    '彰化縣員林市三義里' => '10007-04',
    '彰化縣員林市新生里' => '10007-04',
    '彰化縣員林市南平里' => '10007-04',
    '彰化縣員林市南興里' => '10007-04',
    '彰化縣員林市源潭里' => '10007-04',
    '彰化縣員林市大埔里' => '10007-04',
    '彰化縣員林市三條里' => '10007-04',
    '彰化縣員林市三和里' => '10007-04',
    '彰化縣員林市三橋里' => '10007-04',
    '彰化縣員林市中央里' => '10007-04',
    '彰化縣員林市溝皂里' => '10007-04',
    '彰化縣員林市大饒里' => '10007-04',
    '彰化縣員林市大明里' => '10007-04',
    '彰化縣員林市萬年里' => '10007-04',
    '彰化縣員林市崙雅里' => '10007-04',
    '彰化縣員林市振興里' => '10007-04',
    '彰化縣員林市林厝里' => '10007-04',
    '彰化縣員林市出水里' => '10007-04',
    '彰化縣員林市湖水里' => '10007-04',
    '彰化縣員林市大峯里' => '10007-04',
    '彰化縣員林市鎮興里' => '10007-04',
    '彰化縣員林市浮圳里' => '10007-04',
    '彰化縣員林市西東里' => '10007-04',
    '彰化縣員林市南東里' => '10007-04',
    '彰化縣員林市中東里' => '10007-04',
    '彰化縣員林市東北里' => '10007-04',
    '彰化縣員林市三愛里' => '10007-04',
    '彰化縣員林市三信里' => '10007-04',
    '彰化縣員林市三多里' => '10007-04',
    '彰化縣員林市仁愛里' => '10007-04',
    '彰化縣員林市忠孝里' => '10007-04',
    '彰化縣埔鹽鄉廍子村' => '10007-05',
    '彰化縣埔鹽鄉瓦磘村' => '10007-05',
    '彰化縣埔心鄉舊舘村' => '10007-05',
    '彰化縣埔心鄉南舘村' => '10007-05',
    '彰化縣埔心鄉新舘村' => '10007-05',
    '彰化縣埔心鄉埤脚村' => '10007-05',
    '彰化縣芳苑鄉頂廍村' => '10007-08',
    '彰化縣大城鄉台西村' => '10007-08',
    '南投縣竹山鎮硘磘里' => '10008-04',
    '南投縣名間鄉廍下村' => '10008-01',
    '南投縣仁愛鄉都達村' => '10008-05',
    '雲林縣斗六市溝垻里' => '10009-01',
    '雲林縣斗六市崙峯里' => '10009-01',
    '雲林縣斗六市文化里' => '10009-01',
    '雲林縣斗南鎮大同里' => '10009-02',
    '雲林縣斗南鎮僑真里' => '10009-02',
    '雲林縣西螺鎮公舘里' => '10009-04',
    '雲林縣北港鎮公舘里' => '10009-06',
    '雲林縣麥寮鄉瓦磘村' => '10009-05',
    '雲林縣元長鄉瓦磘村' => '10009-03',
    '雲林縣四湖鄉萡子村' => '10009-05',
    '雲林縣四湖鄉萡東村' => '10009-05',
    '雲林縣水林鄉瓊埔村' => '10009-06',
    '嘉義縣朴子市双溪里' => '10010-04',
    '嘉義縣民雄鄉双福村' => '10010-02',
    '嘉義縣中埔鄉塩舘村' => '10010-06',
    '嘉義縣中埔鄉石硦村' => '10010-06',
    '嘉義縣竹崎鄉文峯村' => '10010-06',
    '嘉義縣梅山鄉双溪村' => '10010-03',
    '嘉義縣梅山鄉瑞峯村' => '10010-03',
    '屏東縣東港鎮下廍里' => '10013-04',
    '屏東縣萬丹鄉厦北村' => '10013-04',
    '屏東縣萬丹鄉厦南村' => '10013-04',
    '屏東縣里港鄉三廍村' => '10013-02',
    '屏東縣新園鄉瓦磘村' => '10013-04',
    '屏東縣林邊鄉崎峯村' => '10013-05',
    '屏東縣滿州鄉响林村' => '10013-06',
    '屏東縣瑪家鄉凉山村' => '10013-02',
    '臺東縣關山鎮里壠里' => '10014-04',
    '臺東縣綠島鄉公舘村' => '10014-06',
    '臺東縣達仁鄉台坂村' => '10014-05',
    '臺東縣達仁鄉土坂村' => '10014-05',
    '澎湖縣馬公市嵵裡里' => '10016-01',
    '澎湖縣湖西鄉菓葉村' => '10016-02',
    '嘉義市西區磚磘里' => '10020-02',
    '連江縣北竿鄉坂里村' => '09007-02',
    '連江縣莒光鄉西坵村' => '09007-03',
    '金門縣金城鎮西門里' => '09020-01',
    '金門縣金城鎮南門里' => '09020-01',
    '金門縣金城鎮北門里' => '09020-01',
];

while ($line = fgetcsv($fh, 2048)) {
    $zones[$line[1] . $line[2] . $line[3]] = $line[0];
}
$data2020 = json_decode(file_get_contents(dirname(dirname(__DIR__)) . '/data/2020_party_cunli.json'), true);
$pool = [];
foreach ($data2020 as $item) {
    if (!isset($zones[$item['name']])) {
        if (false !== strpos($item['name'], '、')) {
            $parts = explode('、', $item['name']);
            $prefix = false;
            foreach ($parts as $part) {
                if (false === $prefix) {
                    $prefix = mb_substr($part, 0, -3, 'utf-8');
                } else {
                    $part = $prefix . $part;
                }
                if (isset($zones[$part])) {
                    $item['zone'] = $zones[$part];
                    $pool[$part] = $item;
                }
            }
        }
    } else {
        $item['zone'] = $zones[$item['name']];
        $pool[$item['name']] = $item;
    }
}
$json = json_decode(file_get_contents('/home/kiang/public_html/taiwan_basecode/cunli/geo/20191121.json'), true);

$keyMap = [
    '臺南市新化區[那]拔里' => '臺南市新化區𦰡拔里',
    '臺南市龍崎區石[曹]里' => '臺南市龍崎區石𥕢里',
    '雲林縣水林鄉欍埔村' => '雲林縣水林鄉瓊埔村',
    '彰化縣大城鄉臺西村' => '彰化縣大城鄉台西村',
    '雲林縣斗六市溝埧里' => '雲林縣斗六市溝垻里',
    '新北市坪林區石[曹]里' => '新北市坪林區石𥕢里',
    '新北市瑞芳區濂新里' => '新北市瑞芳區濓新里',
    '新北市瑞芳區濂洞里' => '新北市瑞芳區濓洞里',
];
$zones = [];
$details = [];
foreach ($json['features'] as $g) {
    if (!empty($g['properties']['VILLNAME'])) {
        $key = $g['properties']['COUNTYNAME'] . $g['properties']['TOWNNAME'] . $g['properties']['VILLNAME'];
        if (isset($keyMap[$key])) {
            $key = $keyMap[$key];
        }
        if (isset($pool[$key])) {
            if (!isset($zones[$pool[$key]['zone']])) {
                $zones[$pool[$key]['zone']] = [];
            }
            $details[$g['properties']['VILLCODE']] = $pool[$key]['votes'];
            $g['properties'] = [
                'id' => $g['properties']['VILLCODE'],
                'name' => mb_substr($key, 3, null, 'utf-8'),
                'votes' => $pool[$key]['votes']['台灣民眾黨'],
                'total' => $pool[$key]['total'],
                'rate' => round($pool[$key]['votes']['台灣民眾黨'] / $pool[$key]['total'] * 100, 2),
            ];
            $zones[$pool[$key]['zone']][] = $g;
        }
    }
}

file_put_contents($dataPath . '/council/2022/zone/details.json', json_encode($details, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));

foreach ($zones as $code => $features) {
    $fc = [
        'type' => 'FeatureCollection',
        'features' => $features,
    ];
    file_put_contents($dataPath . '/council/2022/zone/' . $code . '.json', json_encode($fc, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
}
